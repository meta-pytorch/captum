#!/usr/bin/env python3

import unittest

import torch
from captum._utils.typing import TensorOrTupleOfTensorsGeneric
from captum.attr._core.multiscale_fast_cam import MultiscaleFastCam
from torch.nn import Module

from ..helpers.basic import BaseTest, assertTensorAlmostEqual
from ..helpers.basic_models import BasicModel_ConvNet


class Test(BaseTest):
    def test_one_layer_gamma(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        ex = {}
        ex["attributions"] = [
            [
                [
                    2.1217e-09,
                    2.7732e-02,
                    5.3324e-02,
                    7.7865e-02,
                    1.0158e-01,
                    1.2457e-01,
                    1.4690e-01,
                    1.6862e-01,
                ],
                [
                    2.3040e-01,
                    2.4994e-01,
                    2.6899e-01,
                    2.8755e-01,
                    3.0564e-01,
                    3.2329e-01,
                    3.4049e-01,
                    3.5726e-01,
                ],
                [
                    4.0511e-01,
                    4.2027e-01,
                    4.3506e-01,
                    4.4947e-01,
                    4.6353e-01,
                    4.7724e-01,
                    4.9060e-01,
                    5.0363e-01,
                ],
                [
                    5.4081e-01,
                    5.5259e-01,
                    5.6407e-01,
                    5.7527e-01,
                    5.8618e-01,
                    5.9682e-01,
                    6.0720e-01,
                    6.1731e-01,
                ],
                [
                    6.4615e-01,
                    6.5528e-01,
                    6.6418e-01,
                    6.7286e-01,
                    6.8131e-01,
                    6.8956e-01,
                    6.9759e-01,
                    7.0542e-01,
                ],
                [
                    7.2774e-01,
                    7.3481e-01,
                    7.4169e-01,
                    7.4840e-01,
                    7.5494e-01,
                    7.6131e-01,
                    7.6752e-01,
                    7.7357e-01,
                ],
                [
                    7.9080e-01,
                    7.9626e-01,
                    8.0157e-01,
                    8.0674e-01,
                    8.1178e-01,
                    8.1670e-01,
                    8.2148e-01,
                    8.2614e-01,
                ],
                [
                    8.3941e-01,
                    8.4361e-01,
                    8.4769e-01,
                    8.5167e-01,
                    8.5554e-01,
                    8.5932e-01,
                    8.6299e-01,
                    8.6657e-01,
                ],
            ]
        ]
        layers = [net.relu1]
        norm = "gamma"
        combine = False
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine)

    def test_one_layer_gamma_multiinput(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        inp = inp.repeat(2, 1, 1, 1)
        ex = {}
        ex["attributions"] = [
            [
                [
                    2.1217e-09,
                    2.7732e-02,
                    5.3324e-02,
                    7.7865e-02,
                    1.0158e-01,
                    1.2457e-01,
                    1.4690e-01,
                    1.6862e-01,
                ],
                [
                    2.3040e-01,
                    2.4994e-01,
                    2.6899e-01,
                    2.8755e-01,
                    3.0564e-01,
                    3.2329e-01,
                    3.4049e-01,
                    3.5726e-01,
                ],
                [
                    4.0511e-01,
                    4.2027e-01,
                    4.3506e-01,
                    4.4947e-01,
                    4.6353e-01,
                    4.7724e-01,
                    4.9060e-01,
                    5.0363e-01,
                ],
                [
                    5.4081e-01,
                    5.5259e-01,
                    5.6407e-01,
                    5.7527e-01,
                    5.8618e-01,
                    5.9682e-01,
                    6.0720e-01,
                    6.1731e-01,
                ],
                [
                    6.4615e-01,
                    6.5528e-01,
                    6.6418e-01,
                    6.7286e-01,
                    6.8131e-01,
                    6.8956e-01,
                    6.9759e-01,
                    7.0542e-01,
                ],
                [
                    7.2774e-01,
                    7.3481e-01,
                    7.4169e-01,
                    7.4840e-01,
                    7.5494e-01,
                    7.6131e-01,
                    7.6752e-01,
                    7.7357e-01,
                ],
                [
                    7.9080e-01,
                    7.9626e-01,
                    8.0157e-01,
                    8.0674e-01,
                    8.1178e-01,
                    8.1670e-01,
                    8.2148e-01,
                    8.2614e-01,
                ],
                [
                    8.3941e-01,
                    8.4361e-01,
                    8.4769e-01,
                    8.5167e-01,
                    8.5554e-01,
                    8.5932e-01,
                    8.6299e-01,
                    8.6657e-01,
                ],
            ],
            [
                [
                    2.1217e-09,
                    2.7732e-02,
                    5.3324e-02,
                    7.7865e-02,
                    1.0158e-01,
                    1.2457e-01,
                    1.4690e-01,
                    1.6862e-01,
                ],
                [
                    2.3040e-01,
                    2.4994e-01,
                    2.6899e-01,
                    2.8755e-01,
                    3.0564e-01,
                    3.2329e-01,
                    3.4049e-01,
                    3.5726e-01,
                ],
                [
                    4.0511e-01,
                    4.2027e-01,
                    4.3506e-01,
                    4.4947e-01,
                    4.6353e-01,
                    4.7724e-01,
                    4.9060e-01,
                    5.0363e-01,
                ],
                [
                    5.4081e-01,
                    5.5259e-01,
                    5.6407e-01,
                    5.7527e-01,
                    5.8618e-01,
                    5.9682e-01,
                    6.0720e-01,
                    6.1731e-01,
                ],
                [
                    6.4615e-01,
                    6.5528e-01,
                    6.6418e-01,
                    6.7286e-01,
                    6.8131e-01,
                    6.8956e-01,
                    6.9759e-01,
                    7.0542e-01,
                ],
                [
                    7.2774e-01,
                    7.3481e-01,
                    7.4169e-01,
                    7.4840e-01,
                    7.5494e-01,
                    7.6131e-01,
                    7.6752e-01,
                    7.7357e-01,
                ],
                [
                    7.9080e-01,
                    7.9626e-01,
                    8.0157e-01,
                    8.0674e-01,
                    8.1178e-01,
                    8.1670e-01,
                    8.2148e-01,
                    8.2614e-01,
                ],
                [
                    8.3941e-01,
                    8.4361e-01,
                    8.4769e-01,
                    8.5167e-01,
                    8.5554e-01,
                    8.5932e-01,
                    8.6299e-01,
                    8.6657e-01,
                ],
            ],
        ]
        layers = [net.relu1]
        norm = "gamma"
        combine = False
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine)

    def test_one_layer_gaussian(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        ex = {}
        ex["attributions"] = [
            [
                [0.0518, 0.0562, 0.0609, 0.0659, 0.0712, 0.0769, 0.0829, 0.0893],
                [0.1109, 0.1189, 0.1273, 0.1362, 0.1454, 0.1552, 0.1654, 0.1760],
                [0.2105, 0.2229, 0.2357, 0.2489, 0.2626, 0.2766, 0.2910, 0.3058],
                [0.3521, 0.3682, 0.3845, 0.4010, 0.4177, 0.4346, 0.4516, 0.4687],
                [0.5205, 0.5377, 0.5549, 0.5720, 0.5890, 0.6059, 0.6225, 0.6390],
                [0.6868, 0.7022, 0.7172, 0.7318, 0.7461, 0.7599, 0.7734, 0.7864],
                [0.8228, 0.8341, 0.8448, 0.8551, 0.8650, 0.8743, 0.8833, 0.8917],
                [0.9145, 0.9212, 0.9275, 0.9335, 0.9390, 0.9442, 0.9491, 0.9536],
            ]
        ]
        layers = [net.relu1]
        norm = "gaussian"
        combine = False
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine)

    def test_one_layer_gaussian_multilayer(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        inp = inp.repeat(2, 1, 1, 1)
        ex = {}
        ex["attributions"] = [
            [
                [0.0518, 0.0562, 0.0609, 0.0659, 0.0712, 0.0769, 0.0829, 0.0893],
                [0.1109, 0.1189, 0.1273, 0.1362, 0.1454, 0.1552, 0.1654, 0.1760],
                [0.2105, 0.2229, 0.2357, 0.2489, 0.2626, 0.2766, 0.2910, 0.3058],
                [0.3521, 0.3682, 0.3845, 0.4010, 0.4177, 0.4346, 0.4516, 0.4687],
                [0.5205, 0.5377, 0.5549, 0.5720, 0.5890, 0.6059, 0.6225, 0.6390],
                [0.6868, 0.7022, 0.7172, 0.7318, 0.7461, 0.7599, 0.7734, 0.7864],
                [0.8228, 0.8341, 0.8448, 0.8551, 0.8650, 0.8743, 0.8833, 0.8917],
                [0.9145, 0.9212, 0.9275, 0.9335, 0.9390, 0.9442, 0.9491, 0.9536],
            ],
            [
                [0.0518, 0.0562, 0.0609, 0.0659, 0.0712, 0.0769, 0.0829, 0.0893],
                [0.1109, 0.1189, 0.1273, 0.1362, 0.1454, 0.1552, 0.1654, 0.1760],
                [0.2105, 0.2229, 0.2357, 0.2489, 0.2626, 0.2766, 0.2910, 0.3058],
                [0.3521, 0.3682, 0.3845, 0.4010, 0.4177, 0.4346, 0.4516, 0.4687],
                [0.5205, 0.5377, 0.5549, 0.5720, 0.5890, 0.6059, 0.6225, 0.6390],
                [0.6868, 0.7022, 0.7172, 0.7318, 0.7461, 0.7599, 0.7734, 0.7864],
                [0.8228, 0.8341, 0.8448, 0.8551, 0.8650, 0.8743, 0.8833, 0.8917],
                [0.9145, 0.9212, 0.9275, 0.9335, 0.9390, 0.9442, 0.9491, 0.9536],
            ],
        ]
        layers = [net.relu1]
        norm = "gaussian"
        combine = False
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine)

    def test_one_layer_none(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        ex = {}
        ex["attributions"] = [
            [
                [
                    26.5969,
                    29.4047,
                    32.2272,
                    35.0631,
                    37.9115,
                    40.7714,
                    43.6420,
                    46.5228,
                ],
                [
                    55.2201,
                    58.1360,
                    61.0596,
                    63.9905,
                    66.9284,
                    69.8731,
                    72.8243,
                    75.7817,
                ],
                [
                    84.6891,
                    87.6693,
                    90.6546,
                    93.6451,
                    96.6404,
                    99.6406,
                    102.6453,
                    105.6546,
                ],
                [
                    114.7082,
                    117.7343,
                    120.7643,
                    123.7983,
                    126.8359,
                    129.8773,
                    132.9223,
                    135.9708,
                ],
                [
                    145.1367,
                    148.1985,
                    151.2635,
                    154.3317,
                    157.4030,
                    160.4772,
                    163.5544,
                    166.6344,
                ],
                [
                    175.8915,
                    178.9827,
                    182.0765,
                    185.1729,
                    188.2719,
                    191.3735,
                    194.4775,
                    197.5840,
                ],
                [
                    206.9179,
                    210.0338,
                    213.1521,
                    216.2726,
                    219.3953,
                    222.5202,
                    225.6473,
                    228.7765,
                ],
                [
                    238.1767,
                    241.3142,
                    244.4537,
                    247.5951,
                    250.7385,
                    253.8839,
                    257.0312,
                    260.1803,
                ],
            ]
        ]
        layers = [net.relu1]
        norm = None
        combine = False
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine)

    def test_one_layer_none_multilayer(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        inp = inp.repeat(2, 1, 1, 1)
        ex = {}
        ex["attributions"] = [
            [
                [
                    26.5969,
                    29.4047,
                    32.2272,
                    35.0631,
                    37.9115,
                    40.7714,
                    43.6420,
                    46.5228,
                ],
                [
                    55.2201,
                    58.1360,
                    61.0596,
                    63.9905,
                    66.9284,
                    69.8731,
                    72.8243,
                    75.7817,
                ],
                [
                    84.6891,
                    87.6693,
                    90.6546,
                    93.6451,
                    96.6404,
                    99.6406,
                    102.6453,
                    105.6546,
                ],
                [
                    114.7082,
                    117.7343,
                    120.7643,
                    123.7983,
                    126.8359,
                    129.8773,
                    132.9223,
                    135.9708,
                ],
                [
                    145.1367,
                    148.1985,
                    151.2635,
                    154.3317,
                    157.4030,
                    160.4772,
                    163.5544,
                    166.6344,
                ],
                [
                    175.8915,
                    178.9827,
                    182.0765,
                    185.1729,
                    188.2719,
                    191.3735,
                    194.4775,
                    197.5840,
                ],
                [
                    206.9179,
                    210.0338,
                    213.1521,
                    216.2726,
                    219.3953,
                    222.5202,
                    225.6473,
                    228.7765,
                ],
                [
                    238.1767,
                    241.3142,
                    244.4537,
                    247.5951,
                    250.7385,
                    253.8839,
                    257.0312,
                    260.1803,
                ],
            ],
            [
                [
                    26.5969,
                    29.4047,
                    32.2272,
                    35.0631,
                    37.9115,
                    40.7714,
                    43.6420,
                    46.5228,
                ],
                [
                    55.2201,
                    58.1360,
                    61.0596,
                    63.9905,
                    66.9284,
                    69.8731,
                    72.8243,
                    75.7817,
                ],
                [
                    84.6891,
                    87.6693,
                    90.6546,
                    93.6451,
                    96.6404,
                    99.6406,
                    102.6453,
                    105.6546,
                ],
                [
                    114.7082,
                    117.7343,
                    120.7643,
                    123.7983,
                    126.8359,
                    129.8773,
                    132.9223,
                    135.9708,
                ],
                [
                    145.1367,
                    148.1985,
                    151.2635,
                    154.3317,
                    157.4030,
                    160.4772,
                    163.5544,
                    166.6344,
                ],
                [
                    175.8915,
                    178.9827,
                    182.0765,
                    185.1729,
                    188.2719,
                    191.3735,
                    194.4775,
                    197.5840,
                ],
                [
                    206.9179,
                    210.0338,
                    213.1521,
                    216.2726,
                    219.3953,
                    222.5202,
                    225.6473,
                    228.7765,
                ],
                [
                    238.1767,
                    241.3142,
                    244.4537,
                    247.5951,
                    250.7385,
                    253.8839,
                    257.0312,
                    260.1803,
                ],
            ],
        ]
        layers = [net.relu1]
        norm = None
        combine = False
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine)

    def test_two_layer_after_combine(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        ex = {}
        ex["attributions"] = [
            [
                [
                    2.1217e-09,
                    2.7732e-02,
                    5.3324e-02,
                    7.7865e-02,
                    1.0158e-01,
                    1.2457e-01,
                    1.4690e-01,
                    1.6862e-01,
                ],
                [
                    2.3040e-01,
                    2.4994e-01,
                    2.6899e-01,
                    2.8755e-01,
                    3.0564e-01,
                    3.2329e-01,
                    3.4049e-01,
                    3.5726e-01,
                ],
                [
                    4.0511e-01,
                    4.2027e-01,
                    4.3506e-01,
                    4.4947e-01,
                    4.6353e-01,
                    4.7724e-01,
                    4.9060e-01,
                    5.0363e-01,
                ],
                [
                    5.4081e-01,
                    5.5259e-01,
                    5.6407e-01,
                    5.7527e-01,
                    5.8618e-01,
                    5.9682e-01,
                    6.0720e-01,
                    6.1731e-01,
                ],
                [
                    6.4615e-01,
                    6.5528e-01,
                    6.6418e-01,
                    6.7286e-01,
                    6.8131e-01,
                    6.8956e-01,
                    6.9759e-01,
                    7.0542e-01,
                ],
                [
                    7.2774e-01,
                    7.3481e-01,
                    7.4169e-01,
                    7.4840e-01,
                    7.5494e-01,
                    7.6131e-01,
                    7.6752e-01,
                    7.7357e-01,
                ],
                [
                    7.9080e-01,
                    7.9626e-01,
                    8.0157e-01,
                    8.0674e-01,
                    8.1178e-01,
                    8.1670e-01,
                    8.2148e-01,
                    8.2614e-01,
                ],
                [
                    8.3941e-01,
                    8.4361e-01,
                    8.4769e-01,
                    8.5167e-01,
                    8.5554e-01,
                    8.5932e-01,
                    8.6299e-01,
                    8.6657e-01,
                ],
            ],
            [[0.0409, 0.5404], [0.8571, 0.8620]],
        ]
        ex["combined_map"] = [
            [
                [
                    0.0204,
                    0.0301,
                    0.0407,
                    0.1007,
                    0.1605,
                    0.2199,
                    0.2791,
                    0.3381,
                    0.3469,
                    0.3545,
                ],
                [
                    0.1011,
                    0.1088,
                    0.1173,
                    0.1756,
                    0.2336,
                    0.2915,
                    0.3492,
                    0.4067,
                    0.4141,
                    0.4205,
                ],
                [
                    0.1793,
                    0.1854,
                    0.1922,
                    0.2489,
                    0.3054,
                    0.3618,
                    0.4180,
                    0.4741,
                    0.4802,
                    0.4854,
                ],
                [
                    0.3250,
                    0.3299,
                    0.3355,
                    0.3810,
                    0.4264,
                    0.4717,
                    0.5169,
                    0.5620,
                    0.5670,
                    0.5712,
                ],
                [
                    0.4594,
                    0.4634,
                    0.4679,
                    0.5025,
                    0.5371,
                    0.5715,
                    0.6058,
                    0.6401,
                    0.6441,
                    0.6476,
                ],
                [
                    0.5831,
                    0.5864,
                    0.5901,
                    0.6140,
                    0.6378,
                    0.6616,
                    0.6853,
                    0.7089,
                    0.7122,
                    0.7150,
                ],
                [
                    0.6986,
                    0.7013,
                    0.7043,
                    0.7176,
                    0.7309,
                    0.7442,
                    0.7573,
                    0.7704,
                    0.7731,
                    0.7754,
                ],
                [
                    0.8082,
                    0.8104,
                    0.8129,
                    0.8158,
                    0.8186,
                    0.8214,
                    0.8242,
                    0.8269,
                    0.8291,
                    0.8310,
                ],
                [
                    0.8313,
                    0.8330,
                    0.8350,
                    0.8375,
                    0.8399,
                    0.8423,
                    0.8446,
                    0.8469,
                    0.8486,
                    0.8502,
                ],
                [
                    0.8483,
                    0.8497,
                    0.8514,
                    0.8535,
                    0.8556,
                    0.8576,
                    0.8596,
                    0.8616,
                    0.8631,
                    0.8643,
                ],
            ]
        ]
        ex["weighted_maps"] = [
            [
                [
                    [
                        2.1217e-09,
                        1.9412e-02,
                        4.0528e-02,
                        6.0686e-02,
                        8.0236e-02,
                        9.9207e-02,
                        1.1767e-01,
                        1.3574e-01,
                        1.5342e-01,
                        1.6862e-01,
                    ],
                    [
                        1.6128e-01,
                        1.7668e-01,
                        1.9378e-01,
                        2.1039e-01,
                        2.2662e-01,
                        2.4245e-01,
                        2.5790e-01,
                        2.7304e-01,
                        2.8789e-01,
                        3.0067e-01,
                    ],
                    [
                        3.1776e-01,
                        3.2990e-01,
                        3.4356e-01,
                        3.5697e-01,
                        3.7012e-01,
                        3.8298e-01,
                        3.9556e-01,
                        4.0790e-01,
                        4.2002e-01,
                        4.3045e-01,
                    ],
                    [
                        4.4582e-01,
                        4.5572e-01,
                        4.6686e-01,
                        4.7780e-01,
                        4.8852e-01,
                        4.9901e-01,
                        5.0928e-01,
                        5.1935e-01,
                        5.2923e-01,
                        5.3774e-01,
                    ],
                    [
                        5.5134e-01,
                        5.5940e-01,
                        5.6847e-01,
                        5.7737e-01,
                        5.8609e-01,
                        5.9463e-01,
                        6.0298e-01,
                        6.1117e-01,
                        6.1920e-01,
                        6.2612e-01,
                    ],
                    [
                        6.3561e-01,
                        6.4219e-01,
                        6.4959e-01,
                        6.5685e-01,
                        6.6397e-01,
                        6.7093e-01,
                        6.7774e-01,
                        6.8442e-01,
                        6.9097e-01,
                        6.9661e-01,
                    ],
                    [
                        7.0326e-01,
                        7.0864e-01,
                        7.1469e-01,
                        7.2063e-01,
                        7.2645e-01,
                        7.3214e-01,
                        7.3770e-01,
                        7.4316e-01,
                        7.4852e-01,
                        7.5312e-01,
                    ],
                    [
                        7.5927e-01,
                        7.6365e-01,
                        7.6858e-01,
                        7.7341e-01,
                        7.7815e-01,
                        7.8278e-01,
                        7.8731e-01,
                        7.9175e-01,
                        7.9611e-01,
                        7.9986e-01,
                    ],
                    [
                        8.0539e-01,
                        8.0894e-01,
                        8.1293e-01,
                        8.1685e-01,
                        8.2069e-01,
                        8.2444e-01,
                        8.2811e-01,
                        8.3171e-01,
                        8.3523e-01,
                        8.3827e-01,
                    ],
                    [
                        8.3941e-01,
                        8.4235e-01,
                        8.4565e-01,
                        8.4888e-01,
                        8.5206e-01,
                        8.5516e-01,
                        8.5818e-01,
                        8.6115e-01,
                        8.6406e-01,
                        8.6657e-01,
                    ],
                ],
                [
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        2.0412e-01,
                        2.0412e-01,
                        2.0412e-01,
                        2.8423e-01,
                        3.6435e-01,
                        4.4447e-01,
                        5.2459e-01,
                        6.0471e-01,
                        6.0471e-01,
                        6.0471e-01,
                    ],
                    [
                        3.6737e-01,
                        3.6737e-01,
                        3.6737e-01,
                        4.2770e-01,
                        4.8804e-01,
                        5.4837e-01,
                        6.0871e-01,
                        6.6905e-01,
                        6.6905e-01,
                        6.6905e-01,
                    ],
                    [
                        5.3062e-01,
                        5.3062e-01,
                        5.3062e-01,
                        5.7117e-01,
                        6.1172e-01,
                        6.5228e-01,
                        6.9283e-01,
                        7.3338e-01,
                        7.3338e-01,
                        7.3338e-01,
                    ],
                    [
                        6.9387e-01,
                        6.9387e-01,
                        6.9387e-01,
                        7.1464e-01,
                        7.3541e-01,
                        7.5618e-01,
                        7.7695e-01,
                        7.9772e-01,
                        7.9772e-01,
                        7.9772e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                ],
            ]
        ]
        layers = [net.relu1, net.relu2]
        norm = "gamma"
        combine = True
        weights = [1.0, 1.0]
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine, weights)

    def test_two_layer_after_combine_multiinput(self) -> None:
        net = BasicModel_ConvNet()
        inp = torch.arange(100, dtype=torch.float).view((1, 1, 10, 10))
        inp = inp.repeat(2, 1, 1, 1)
        ex = {}
        ex["attributions"] = [
            [
                [
                    [
                        2.1217e-09,
                        2.7732e-02,
                        5.3324e-02,
                        7.7865e-02,
                        1.0158e-01,
                        1.2457e-01,
                        1.4690e-01,
                        1.6862e-01,
                    ],
                    [
                        2.3040e-01,
                        2.4994e-01,
                        2.6899e-01,
                        2.8755e-01,
                        3.0564e-01,
                        3.2329e-01,
                        3.4049e-01,
                        3.5726e-01,
                    ],
                    [
                        4.0511e-01,
                        4.2027e-01,
                        4.3506e-01,
                        4.4947e-01,
                        4.6353e-01,
                        4.7724e-01,
                        4.9060e-01,
                        5.0363e-01,
                    ],
                    [
                        5.4081e-01,
                        5.5259e-01,
                        5.6407e-01,
                        5.7527e-01,
                        5.8618e-01,
                        5.9682e-01,
                        6.0720e-01,
                        6.1731e-01,
                    ],
                    [
                        6.4615e-01,
                        6.5528e-01,
                        6.6418e-01,
                        6.7286e-01,
                        6.8131e-01,
                        6.8956e-01,
                        6.9759e-01,
                        7.0542e-01,
                    ],
                    [
                        7.2774e-01,
                        7.3481e-01,
                        7.4169e-01,
                        7.4840e-01,
                        7.5494e-01,
                        7.6131e-01,
                        7.6752e-01,
                        7.7357e-01,
                    ],
                    [
                        7.9080e-01,
                        7.9626e-01,
                        8.0157e-01,
                        8.0674e-01,
                        8.1178e-01,
                        8.1670e-01,
                        8.2148e-01,
                        8.2614e-01,
                    ],
                    [
                        8.3941e-01,
                        8.4361e-01,
                        8.4769e-01,
                        8.5167e-01,
                        8.5554e-01,
                        8.5932e-01,
                        8.6299e-01,
                        8.6657e-01,
                    ],
                ],
                [
                    [
                        2.1217e-09,
                        2.7732e-02,
                        5.3324e-02,
                        7.7865e-02,
                        1.0158e-01,
                        1.2457e-01,
                        1.4690e-01,
                        1.6862e-01,
                    ],
                    [
                        2.3040e-01,
                        2.4994e-01,
                        2.6899e-01,
                        2.8755e-01,
                        3.0564e-01,
                        3.2329e-01,
                        3.4049e-01,
                        3.5726e-01,
                    ],
                    [
                        4.0511e-01,
                        4.2027e-01,
                        4.3506e-01,
                        4.4947e-01,
                        4.6353e-01,
                        4.7724e-01,
                        4.9060e-01,
                        5.0363e-01,
                    ],
                    [
                        5.4081e-01,
                        5.5259e-01,
                        5.6407e-01,
                        5.7527e-01,
                        5.8618e-01,
                        5.9682e-01,
                        6.0720e-01,
                        6.1731e-01,
                    ],
                    [
                        6.4615e-01,
                        6.5528e-01,
                        6.6418e-01,
                        6.7286e-01,
                        6.8131e-01,
                        6.8956e-01,
                        6.9759e-01,
                        7.0542e-01,
                    ],
                    [
                        7.2774e-01,
                        7.3481e-01,
                        7.4169e-01,
                        7.4840e-01,
                        7.5494e-01,
                        7.6131e-01,
                        7.6752e-01,
                        7.7357e-01,
                    ],
                    [
                        7.9080e-01,
                        7.9626e-01,
                        8.0157e-01,
                        8.0674e-01,
                        8.1178e-01,
                        8.1670e-01,
                        8.2148e-01,
                        8.2614e-01,
                    ],
                    [
                        8.3941e-01,
                        8.4361e-01,
                        8.4769e-01,
                        8.5167e-01,
                        8.5554e-01,
                        8.5932e-01,
                        8.6299e-01,
                        8.6657e-01,
                    ],
                ],
            ],
            [
                [[0.0409, 0.5404], [0.8571, 0.8620]],
                [[0.0409, 0.5404], [0.8571, 0.8620]],
            ],
        ]
        ex["combined_map"] = [
            [
                [
                    0.0204,
                    0.0301,
                    0.0407,
                    0.1007,
                    0.1605,
                    0.2199,
                    0.2791,
                    0.3381,
                    0.3469,
                    0.3545,
                ],
                [
                    0.1011,
                    0.1088,
                    0.1173,
                    0.1756,
                    0.2336,
                    0.2915,
                    0.3492,
                    0.4067,
                    0.4141,
                    0.4205,
                ],
                [
                    0.1793,
                    0.1854,
                    0.1922,
                    0.2489,
                    0.3054,
                    0.3618,
                    0.4180,
                    0.4741,
                    0.4802,
                    0.4854,
                ],
                [
                    0.3250,
                    0.3299,
                    0.3355,
                    0.3810,
                    0.4264,
                    0.4717,
                    0.5169,
                    0.5620,
                    0.5670,
                    0.5712,
                ],
                [
                    0.4594,
                    0.4634,
                    0.4679,
                    0.5025,
                    0.5371,
                    0.5715,
                    0.6058,
                    0.6401,
                    0.6441,
                    0.6476,
                ],
                [
                    0.5831,
                    0.5864,
                    0.5901,
                    0.6140,
                    0.6378,
                    0.6616,
                    0.6853,
                    0.7089,
                    0.7122,
                    0.7150,
                ],
                [
                    0.6986,
                    0.7013,
                    0.7043,
                    0.7176,
                    0.7309,
                    0.7442,
                    0.7573,
                    0.7704,
                    0.7731,
                    0.7754,
                ],
                [
                    0.8082,
                    0.8104,
                    0.8129,
                    0.8158,
                    0.8186,
                    0.8214,
                    0.8242,
                    0.8269,
                    0.8291,
                    0.8310,
                ],
                [
                    0.8313,
                    0.8330,
                    0.8350,
                    0.8375,
                    0.8399,
                    0.8423,
                    0.8446,
                    0.8469,
                    0.8486,
                    0.8502,
                ],
                [
                    0.8483,
                    0.8497,
                    0.8514,
                    0.8535,
                    0.8556,
                    0.8576,
                    0.8596,
                    0.8616,
                    0.8631,
                    0.8643,
                ],
            ],
            [
                [
                    0.0204,
                    0.0301,
                    0.0407,
                    0.1007,
                    0.1605,
                    0.2199,
                    0.2791,
                    0.3381,
                    0.3469,
                    0.3545,
                ],
                [
                    0.1011,
                    0.1088,
                    0.1173,
                    0.1756,
                    0.2336,
                    0.2915,
                    0.3492,
                    0.4067,
                    0.4141,
                    0.4205,
                ],
                [
                    0.1793,
                    0.1854,
                    0.1922,
                    0.2489,
                    0.3054,
                    0.3618,
                    0.4180,
                    0.4741,
                    0.4802,
                    0.4854,
                ],
                [
                    0.3250,
                    0.3299,
                    0.3355,
                    0.3810,
                    0.4264,
                    0.4717,
                    0.5169,
                    0.5620,
                    0.5670,
                    0.5712,
                ],
                [
                    0.4594,
                    0.4634,
                    0.4679,
                    0.5025,
                    0.5371,
                    0.5715,
                    0.6058,
                    0.6401,
                    0.6441,
                    0.6476,
                ],
                [
                    0.5831,
                    0.5864,
                    0.5901,
                    0.6140,
                    0.6378,
                    0.6616,
                    0.6853,
                    0.7089,
                    0.7122,
                    0.7150,
                ],
                [
                    0.6986,
                    0.7013,
                    0.7043,
                    0.7176,
                    0.7309,
                    0.7442,
                    0.7573,
                    0.7704,
                    0.7731,
                    0.7754,
                ],
                [
                    0.8082,
                    0.8104,
                    0.8129,
                    0.8158,
                    0.8186,
                    0.8214,
                    0.8242,
                    0.8269,
                    0.8291,
                    0.8310,
                ],
                [
                    0.8313,
                    0.8330,
                    0.8350,
                    0.8375,
                    0.8399,
                    0.8423,
                    0.8446,
                    0.8469,
                    0.8486,
                    0.8502,
                ],
                [
                    0.8483,
                    0.8497,
                    0.8514,
                    0.8535,
                    0.8556,
                    0.8576,
                    0.8596,
                    0.8616,
                    0.8631,
                    0.8643,
                ],
            ],
        ]
        ex["weighted_maps"] = [
            [
                [
                    [
                        2.1217e-09,
                        1.9412e-02,
                        4.0528e-02,
                        6.0686e-02,
                        8.0236e-02,
                        9.9207e-02,
                        1.1767e-01,
                        1.3574e-01,
                        1.5342e-01,
                        1.6862e-01,
                    ],
                    [
                        1.6128e-01,
                        1.7668e-01,
                        1.9378e-01,
                        2.1039e-01,
                        2.2662e-01,
                        2.4245e-01,
                        2.5790e-01,
                        2.7304e-01,
                        2.8789e-01,
                        3.0067e-01,
                    ],
                    [
                        3.1776e-01,
                        3.2990e-01,
                        3.4356e-01,
                        3.5697e-01,
                        3.7012e-01,
                        3.8298e-01,
                        3.9556e-01,
                        4.0790e-01,
                        4.2002e-01,
                        4.3045e-01,
                    ],
                    [
                        4.4582e-01,
                        4.5572e-01,
                        4.6686e-01,
                        4.7780e-01,
                        4.8852e-01,
                        4.9901e-01,
                        5.0928e-01,
                        5.1935e-01,
                        5.2923e-01,
                        5.3774e-01,
                    ],
                    [
                        5.5134e-01,
                        5.5940e-01,
                        5.6847e-01,
                        5.7737e-01,
                        5.8609e-01,
                        5.9463e-01,
                        6.0298e-01,
                        6.1117e-01,
                        6.1920e-01,
                        6.2612e-01,
                    ],
                    [
                        6.3561e-01,
                        6.4219e-01,
                        6.4959e-01,
                        6.5685e-01,
                        6.6397e-01,
                        6.7093e-01,
                        6.7774e-01,
                        6.8442e-01,
                        6.9097e-01,
                        6.9661e-01,
                    ],
                    [
                        7.0326e-01,
                        7.0864e-01,
                        7.1469e-01,
                        7.2063e-01,
                        7.2645e-01,
                        7.3214e-01,
                        7.3770e-01,
                        7.4316e-01,
                        7.4852e-01,
                        7.5312e-01,
                    ],
                    [
                        7.5927e-01,
                        7.6365e-01,
                        7.6858e-01,
                        7.7341e-01,
                        7.7815e-01,
                        7.8278e-01,
                        7.8731e-01,
                        7.9175e-01,
                        7.9611e-01,
                        7.9986e-01,
                    ],
                    [
                        8.0539e-01,
                        8.0894e-01,
                        8.1293e-01,
                        8.1685e-01,
                        8.2069e-01,
                        8.2444e-01,
                        8.2811e-01,
                        8.3171e-01,
                        8.3523e-01,
                        8.3827e-01,
                    ],
                    [
                        8.3941e-01,
                        8.4235e-01,
                        8.4565e-01,
                        8.4888e-01,
                        8.5206e-01,
                        8.5516e-01,
                        8.5818e-01,
                        8.6115e-01,
                        8.6406e-01,
                        8.6657e-01,
                    ],
                ],
                [
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        2.0412e-01,
                        2.0412e-01,
                        2.0412e-01,
                        2.8423e-01,
                        3.6435e-01,
                        4.4447e-01,
                        5.2459e-01,
                        6.0471e-01,
                        6.0471e-01,
                        6.0471e-01,
                    ],
                    [
                        3.6737e-01,
                        3.6737e-01,
                        3.6737e-01,
                        4.2770e-01,
                        4.8804e-01,
                        5.4837e-01,
                        6.0871e-01,
                        6.6905e-01,
                        6.6905e-01,
                        6.6905e-01,
                    ],
                    [
                        5.3062e-01,
                        5.3062e-01,
                        5.3062e-01,
                        5.7117e-01,
                        6.1172e-01,
                        6.5228e-01,
                        6.9283e-01,
                        7.3338e-01,
                        7.3338e-01,
                        7.3338e-01,
                    ],
                    [
                        6.9387e-01,
                        6.9387e-01,
                        6.9387e-01,
                        7.1464e-01,
                        7.3541e-01,
                        7.5618e-01,
                        7.7695e-01,
                        7.9772e-01,
                        7.9772e-01,
                        7.9772e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                ],
            ],
            [
                [
                    [
                        2.1217e-09,
                        1.9412e-02,
                        4.0528e-02,
                        6.0686e-02,
                        8.0236e-02,
                        9.9207e-02,
                        1.1767e-01,
                        1.3574e-01,
                        1.5342e-01,
                        1.6862e-01,
                    ],
                    [
                        1.6128e-01,
                        1.7668e-01,
                        1.9378e-01,
                        2.1039e-01,
                        2.2662e-01,
                        2.4245e-01,
                        2.5790e-01,
                        2.7304e-01,
                        2.8789e-01,
                        3.0067e-01,
                    ],
                    [
                        3.1776e-01,
                        3.2990e-01,
                        3.4356e-01,
                        3.5697e-01,
                        3.7012e-01,
                        3.8298e-01,
                        3.9556e-01,
                        4.0790e-01,
                        4.2002e-01,
                        4.3045e-01,
                    ],
                    [
                        4.4582e-01,
                        4.5572e-01,
                        4.6686e-01,
                        4.7780e-01,
                        4.8852e-01,
                        4.9901e-01,
                        5.0928e-01,
                        5.1935e-01,
                        5.2923e-01,
                        5.3774e-01,
                    ],
                    [
                        5.5134e-01,
                        5.5940e-01,
                        5.6847e-01,
                        5.7737e-01,
                        5.8609e-01,
                        5.9463e-01,
                        6.0298e-01,
                        6.1117e-01,
                        6.1920e-01,
                        6.2612e-01,
                    ],
                    [
                        6.3561e-01,
                        6.4219e-01,
                        6.4959e-01,
                        6.5685e-01,
                        6.6397e-01,
                        6.7093e-01,
                        6.7774e-01,
                        6.8442e-01,
                        6.9097e-01,
                        6.9661e-01,
                    ],
                    [
                        7.0326e-01,
                        7.0864e-01,
                        7.1469e-01,
                        7.2063e-01,
                        7.2645e-01,
                        7.3214e-01,
                        7.3770e-01,
                        7.4316e-01,
                        7.4852e-01,
                        7.5312e-01,
                    ],
                    [
                        7.5927e-01,
                        7.6365e-01,
                        7.6858e-01,
                        7.7341e-01,
                        7.7815e-01,
                        7.8278e-01,
                        7.8731e-01,
                        7.9175e-01,
                        7.9611e-01,
                        7.9986e-01,
                    ],
                    [
                        8.0539e-01,
                        8.0894e-01,
                        8.1293e-01,
                        8.1685e-01,
                        8.2069e-01,
                        8.2444e-01,
                        8.2811e-01,
                        8.3171e-01,
                        8.3523e-01,
                        8.3827e-01,
                    ],
                    [
                        8.3941e-01,
                        8.4235e-01,
                        8.4565e-01,
                        8.4888e-01,
                        8.5206e-01,
                        8.5516e-01,
                        8.5818e-01,
                        8.6115e-01,
                        8.6406e-01,
                        8.6657e-01,
                    ],
                ],
                [
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        4.0863e-02,
                        4.0863e-02,
                        4.0863e-02,
                        1.4077e-01,
                        2.4067e-01,
                        3.4057e-01,
                        4.4047e-01,
                        5.4038e-01,
                        5.4038e-01,
                        5.4038e-01,
                    ],
                    [
                        2.0412e-01,
                        2.0412e-01,
                        2.0412e-01,
                        2.8423e-01,
                        3.6435e-01,
                        4.4447e-01,
                        5.2459e-01,
                        6.0471e-01,
                        6.0471e-01,
                        6.0471e-01,
                    ],
                    [
                        3.6737e-01,
                        3.6737e-01,
                        3.6737e-01,
                        4.2770e-01,
                        4.8804e-01,
                        5.4837e-01,
                        6.0871e-01,
                        6.6905e-01,
                        6.6905e-01,
                        6.6905e-01,
                    ],
                    [
                        5.3062e-01,
                        5.3062e-01,
                        5.3062e-01,
                        5.7117e-01,
                        6.1172e-01,
                        6.5228e-01,
                        6.9283e-01,
                        7.3338e-01,
                        7.3338e-01,
                        7.3338e-01,
                    ],
                    [
                        6.9387e-01,
                        6.9387e-01,
                        6.9387e-01,
                        7.1464e-01,
                        7.3541e-01,
                        7.5618e-01,
                        7.7695e-01,
                        7.9772e-01,
                        7.9772e-01,
                        7.9772e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                    [
                        8.5713e-01,
                        8.5713e-01,
                        8.5713e-01,
                        8.5811e-01,
                        8.5910e-01,
                        8.6008e-01,
                        8.6106e-01,
                        8.6205e-01,
                        8.6205e-01,
                        8.6205e-01,
                    ],
                ],
            ],
        ]
        layers = [net.relu1, net.relu2]
        norm = "gamma"
        combine = True
        weights = [1.0, 1.0]
        self._fastcam_test_assert(net, inp, ex, layers, norm, combine, weights)

    def _fastcam_test_assert(
        self,
        model: Module,
        test_input: TensorOrTupleOfTensorsGeneric,
        expected,
        layers: [Module, ...],
        norm: str,
        combine: bool,
        weights: [float, ...] = None,
    ) -> None:
        fastcam = MultiscaleFastCam(model, layers=layers, norm=norm)
        attributions = fastcam.attribute(test_input)
        for i in range(len(layers)):
            assertTensorAlmostEqual(
                self, attributions[i], expected["attributions"][i], delta=0.01
            )
        if combine:
            combined_map, weighted_maps = fastcam.combine(
                attributions, weights=weights, output_shape=(10, 10)
            )
            assertTensorAlmostEqual(
                self, combined_map, expected["combined_map"], delta=0.01
            )
            assertTensorAlmostEqual(
                self, weighted_maps, expected["weighted_maps"], delta=0.01
            )


if __name__ == "__main__":
    unittest.main()
